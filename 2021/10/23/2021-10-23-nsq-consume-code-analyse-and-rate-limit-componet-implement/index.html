<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ketao1989.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="一、背景由于nsq消息队列，使用push模式进行消息分发。众所周知，push模式消费消息带来的一个难点，就是消费速率的控制。和pull模式通过consumer端自己主动拉消息来按需消费不同，push模式需要broker端根据对应consumer的消息处理能力来决定控制消息推送速率。如果控制的不当，就会导致consumer机器出现消息阻塞，最终导致业务系统出现非预期故障。 nsq本身提供RDY机制来">
<meta property="og:type" content="article">
<meta property="og:title" content="nsq消息消费原理分析&amp;消费限流实现">
<meta property="og:url" content="https://ketao1989.github.io/2021/10/23/2021-10-23-nsq-consume-code-analyse-and-rate-limit-componet-implement/index.html">
<meta property="og:site_name" content="没有期望的分布">
<meta property="og:description" content="一、背景由于nsq消息队列，使用push模式进行消息分发。众所周知，push模式消费消息带来的一个难点，就是消费速率的控制。和pull模式通过consumer端自己主动拉消息来按需消费不同，push模式需要broker端根据对应consumer的消息处理能力来决定控制消息推送速率。如果控制的不当，就会导致consumer机器出现消息阻塞，最终导致业务系统出现非预期故障。 nsq本身提供RDY机制来">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ketao1989.github.io/images/2021/case_nsq.png">
<meta property="og:image" content="https://ketao1989.github.io/images/2021/nsq_arch_youzan.png">
<meta property="og:image" content="https://ketao1989.github.io/images/2021/build_consumer.png">
<meta property="og:image" content="https://ketao1989.github.io/images/2021/start_consumer.png">
<meta property="og:image" content="https://ketao1989.github.io/images/2021/process_nsq.png">
<meta property="og:image" content="https://ketao1989.github.io/images/2021/nsqd_main.png">
<meta property="og:image" content="https://ketao1989.github.io/images/2021/build_nsqd.png">
<meta property="og:image" content="https://ketao1989.github.io/images/2021/load_meta.png">
<meta property="og:image" content="https://ketao1989.github.io/images/2021/start_nsqd.png">
<meta property="og:image" content="https://ketao1989.github.io/images/2021/process_nsqd.png">
<meta property="og:image" content="https://ketao1989.github.io/images/2021/nsqd_push.png">
<meta property="og:image" content="https://ketao1989.github.io/images/2021/nsqd_rdy.png">
<meta property="og:image" content="https://ketao1989.github.io/images/2021/dry_update.png">
<meta property="og:image" content="https://ketao1989.github.io/images/2021/rdy_rate.png">
<meta property="og:image" content="https://ketao1989.github.io/images/2021/nsq_rate.png">
<meta property="article:published_time" content="2021-10-23T10:00:00.000Z">
<meta property="article:modified_time" content="2021-10-24T12:36:31.873Z">
<meta property="article:author" content="柯小小西">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ketao1989.github.io/images/2021/case_nsq.png">

<link rel="canonical" href="https://ketao1989.github.io/2021/10/23/2021-10-23-nsq-consume-code-analyse-and-rate-limit-componet-implement/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>nsq消息消费原理分析&消费限流实现 | 没有期望的分布</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">没有期望的分布</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">柯小西-技术博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ketao1989.github.io/2021/10/23/2021-10-23-nsq-consume-code-analyse-and-rate-limit-componet-implement/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/ava.gif">
      <meta itemprop="name" content="柯小小西">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="没有期望的分布">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          nsq消息消费原理分析&消费限流实现
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-23 18:00:00" itemprop="dateCreated datePublished" datetime="2021-10-23T18:00:00+08:00">2021-10-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-10-24 20:36:31" itemprop="dateModified" datetime="2021-10-24T20:36:31+08:00">2021-10-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mq/" itemprop="url" rel="index"><span itemprop="name">mq</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mq/nsq/" itemprop="url" rel="index"><span itemprop="name">nsq</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2021/10/23/2021-10-23-nsq-consume-code-analyse-and-rate-limit-componet-implement/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/10/23/2021-10-23-nsq-consume-code-analyse-and-rate-limit-componet-implement/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>8.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h1><p>由于nsq消息队列，使用push模式进行消息分发。众所周知，push模式消费消息带来的一个难点，就是消费速率的控制。和pull模式通过consumer端自己主动拉消息来按需消费不同，push模式需要broker端根据对应consumer的消息处理能力来决定控制消息推送速率。如果控制的不当，就会导致consumer机器出现消息阻塞，最终导致业务系统出现非预期故障。</p>
<p>nsq本身提供RDY机制来控制推送速率，consumer客户端有自己的策略（默认策略见后面章节分析）来更新RDY值，然后定时任务，每隔1s将最新的RDY值告诉broker端，此时broker端按照新的RDY值来推送消息。</p>
<p>生产环境遇到的一个case，业务流程如下：</p>
<p><img src="/images/2021/case_nsq.png" alt="线上case流程"></p>
<p>出现的问题，不是由于consumer客户端本身的处理能力，而是由于外部服务进行了限流，导致超过指定阈值之后，会直接返回错误，这样consumer端就会有大量的消息处理失败，从而出现非预期失败报警。</p>
<p>但是，我们的预期，是希望消息可以按照我们期望的速率进行消费，因此，抛开nsq自身的RDY机制，需要主动控制推送速率，也就是我们需要对消息施加主动限流。</p>
<p>在对nsq 消息消费进行限流之前，先对nsq consumer client端代码进行分析。</p>
<span id="more"></span>

<h1 id="二、nsq消费流程分析"><a href="#二、nsq消费流程分析" class="headerlink" title="二、nsq消费流程分析"></a>二、nsq消费流程分析</h1><p>公司内部，有赞对nsq进行了二次开发，并进行了开源。增加了很多功能- <a target="_blank" rel="noopener" href="https://tech.youzan.com/how-we-redesigned-the-nsq-the-details-of-the-new-arch/">NSQ重塑之详细设计</a>  </p>
<p>整体架构图如下：</p>
<p><img src="/images/2021/nsq_arch_youzan.png" alt="nsq架构"></p>
<p>nsq java客户端也进行了开源，不过开源版本后期没有进行升级维护，这里贴一个早期的设计文档：<a target="_blank" rel="noopener" href="https://tech.youzan.com/how-we-redesign-the-nsq-smart-client/">How we redesign the NSQ-Smart Client</a></p>
<p>本文主要对消息消费的限流能力进行解析，因此，下面主要对消息消费的核心流程进行介绍。</p>
<h2 id="2-1-nsq-consumer-client-实现"><a href="#2-1-nsq-consumer-client-实现" class="headerlink" title="2.1 nsq consumer client 实现"></a>2.1 nsq consumer client 实现</h2><p>nsq 消息消费模块，主要包括三个部分：</p>
<ul>
<li>构造consumer对象</li>
<li>启动consumer对象</li>
<li>处理nsq推送的消息</li>
</ul>
<h3 id="2-1-1-构造consumer对象"><a href="#2-1-1-构造consumer对象" class="headerlink" title="2.1.1 构造consumer对象"></a>2.1.1 构造consumer对象</h3><p>初始化流程，如下：</p>
<p><img src="/images/2021/build_consumer.png" alt="构造nsq consumer流程"></p>
<blockquote>
<p>new consumer 逻辑比较简单，就是设置一些必须的参数，<code>NsqConfig</code>中的很多线程池大小，RDY 策略，各种时间等参数都是在这里加载进去的。<br>本部分，最核心的是在new完bootstrap对象之后，将其处理handler设置为<code>NSQClientInitializer</code>，在<code>NSQClientInitializer</code>类中，是 netty 的 <code>pipeline</code>设置，<code>pipeline</code>的最后handler为<code>NSQHandler</code>，该handler就是具体处理nsq消息的代码部分。<br>此外，在具体的消息处理，使用的是fixed线程池，其缺点是阻塞队列长度int最大，存在内存爆掉的风险。但是，在nsq的整体消费推送架构场景下，由于RDY控制了nsq消息推送，所以风险就不会存在。</p>
</blockquote>
<h3 id="2-1-2-启动consumer，请求消费消息"><a href="#2-1-2-启动consumer，请求消费消息" class="headerlink" title="2.1.2 启动consumer，请求消费消息"></a>2.1.2 启动consumer，请求消费消息</h3><p>在上面初始化完consumer之后，接下来就是去nsqd/broker 服务端申请订阅主题消息，具体流程如下：</p>
<p><img src="/images/2021/start_consumer.png" alt="构造nsq consumer流程"></p>
<blockquote>
<p>以上，对于nsqd的具体处理，后面再详细介绍。<br>主要流程为：1. 获取topic所在的nsqd地址；2. 和nsqd地址进行连接；3.发送SUB指令，请求消费对应topic数据<br>在client中，存在好几个单独的调度线程，周期去远程更新各种地址和数值。<br>start的流程里，有一个周期推送最新RDY值给nsqd，这里的RDY计算策略，绝大部分情况下使用的是默认的。下面贴个代码看下：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> IExpectedRdyUpdatePolicy DEFAULT_EXP_RDY_POLICY = <span class="keyword">new</span> IExpectedRdyUpdatePolicy() &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">expectedRdyIncrease</span><span class="params">(<span class="keyword">int</span> currentExpRdy, <span class="keyword">int</span> expectedRdyConf)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">int</span> newExpRdy = (<span class="keyword">int</span>)(Math.round(currentExpRdy * <span class="number">1.5</span>));  </span><br><span class="line">        <span class="keyword">if</span>(newExpRdy &lt;= expectedRdyConf)  </span><br><span class="line">            <span class="keyword">return</span> newExpRdy;  </span><br><span class="line">        <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="keyword">return</span> expectedRdyConf;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">expectedRdyDecline</span><span class="params">(<span class="keyword">int</span> currentExpRdy, <span class="keyword">int</span> expectedRdy)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">int</span> newExpRdy = (<span class="keyword">int</span>)(currentExpRdy - Math.round(currentExpRdy * <span class="number">0.25</span>));  </span><br><span class="line">        <span class="keyword">if</span>(newExpRdy &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">            <span class="keyword">return</span> newExpRdy;  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>代码逻辑比较简单，就是设置的<code>expectedRdyConf</code>为最大值，然后按照0.5倍增加RDY，按照0.25倍减少RDY。定时任务，会将最终的RDY，推送给nsqd，按照每个conn维度。</p>
<h3 id="2-1-3-接收-amp-处理nsq消息"><a href="#2-1-3-接收-amp-处理nsq消息" class="headerlink" title="2.1.3 接收&amp;处理nsq消息"></a>2.1.3 接收&amp;处理nsq消息</h3><p>启动consumer，和存有topic数据的nsqd建立连接之后，就等待存在新消息之后，nsqd推送消息，然后consumer接收消息。<br>主要处理流程如下：</p>
<p><img src="/images/2021/process_nsq.png" alt="处理nsq流程"></p>
<blockquote>
<p>具体消息读取和处理部分，主要是使用netty能力。在start的过程中，已经和nsqd进行了网络连接，请求SUB消息，再存在待消费消息之后，nsqd会通过这个conn连接进行消息的分发推送。<br>在消息处理成功或者异常情况下，会对RDY进行更新。</p>
</blockquote>
<p>以上三个部分，即nsq consumer客户端的消息订阅和消息接收处理的全过程。</p>
<h2 id="2-2-nsqd-订阅逻辑实现"><a href="#2-2-nsqd-订阅逻辑实现" class="headerlink" title="2.2 nsqd 订阅逻辑实现"></a>2.2 nsqd 订阅逻辑实现</h2><p>由于本文主要介绍nsq消费限流，所以这里主要介绍订阅消费逻辑，为了更完善整个流程，对于消息发送，也会简单介绍。<br>同样，本节分析，同样基于youzan基于nsq二次开发的分支：<a target="_blank" rel="noopener" href="https://github.com/youzan/nsq">youzan/nsq</a></p>
<p>继续按照三部分来介绍订阅逻辑：</p>
<ul>
<li>nsqd服务启动部分(主要是服务初始化资源准备)；</li>
<li>nsqd接收客户端消费请求部分；</li>
<li>nsqd推送消息部分。</li>
</ul>
<p>特别说明，有赞的nsq版本，相对原生nsq做了很多的调整优化，了解代码前，还是再次建议看下：<a target="_blank" rel="noopener" href="https://github.com/youzan/nsq/blob/master/doc/The-details-of-the-new-arch.md">NSQ重塑之详细设计</a></p>
<h3 id="2-2-1-nsqd服务启动部分"><a href="#2-2-1-nsqd服务启动部分" class="headerlink" title="2.2.1 nsqd服务启动部分"></a>2.2.1 nsqd服务启动部分</h3><p>在<code>apps/nsqd</code>中的<code>nsqd.go</code>文件，就是启动nsqd的入口，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">   <span class="keyword">defer</span> glog.Flush()  </span><br><span class="line">   prg := &amp;program&#123;&#125;  </span><br><span class="line">   <span class="keyword">if</span> err := svc.Run(prg, os.Interrupt, syscall.SIGTERM, syscall.SIGHUP, syscall.SIGQUIT, syscall.SIGINT); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">      log.Panic(err)  </span><br><span class="line">   &#125;  </span><br><span class="line">   log.Println(<span class="string">&quot;app exited.&quot;</span>)  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>基于<code>svc</code>框架，有Init、Start、Stop三个方法需要实现，nsqd的核心逻辑在Start方法中，为了更直观看实现流程，这里不尽量不贴源码，做一些简单的类方法时序调用图。</p>
<p><img src="/images/2021/nsqd_main.png" alt="nsqd服务流程"></p>
<p>如上流程，这里针对三个核心点，深入分析下。</p>
<h4 id="2-2-1-1-构造nsqd-server实例"><a href="#2-2-1-1-构造nsqd-server实例" class="headerlink" title="2.2.1.1  构造nsqd server实例"></a>2.2.1.1  构造nsqd server实例</h4><p><img src="/images/2021/build_nsqd.png" alt="构造nsqd流程"></p>
<p>以上涉及到client和nsqd交互流程的，主要是 <code>internalPubLoop</code>设置，这个方法主要包含在消息从producer发送过来之后，核心的处理逻辑。<br>初始化的时候，没有consumer端处理方法的设置，主要是nsqd是针对每个client发送过来的订阅请求构建处理上下文环境的，直接由SUB请求来触发初始化即可。</p>
<h4 id="2-2-1-2-元数据加载"><a href="#2-2-1-2-元数据加载" class="headerlink" title="2.2.1.2 元数据加载"></a>2.2.1.2 元数据加载</h4><p>和流程图介绍的那样，<code>LoadMetadata</code>，主要是完成元数据的加载，包括 topic 和 channel的详细信息，其中在针对topic下的channel构造的时候，会异步协程启动读取持久化设备上消息的任务，然后写入到通道chan中。</p>
<p><img src="/images/2021/load_meta.png" alt="加载元数据流程"></p>
<p>以上涉及到后期消费分析的核心动作，就是在初始化channel的时候，会启动一个golang协程，协程会从存储设备上读取消息数据，然后推送到chan 通道。从chan通道来获取消息，推送到消费端的逻辑，在1.2.2 来分析。</p>
<h4 id="2-2-1-3-启动nsqd-server-服务"><a href="#2-2-1-3-启动nsqd-server-服务" class="headerlink" title="2.2.1.3 启动nsqd server 服务"></a>2.2.1.3 启动nsqd server 服务</h4><p>上面所有内部准备工作处理完成之后，现在可以启动server服务，监听连接请求，处理外部治理了。<br>具体实现时序图如下：</p>
<p><img src="/images/2021/start_nsqd.png" alt="启动nsqd流程"></p>
<p>服务启动之后，等待client发出请求，建立连接，单独协程，处理指令。</p>
<h3 id="2-2-2-nsqd接收客户端消费请求部分"><a href="#2-2-2-nsqd接收客户端消费请求部分" class="headerlink" title="2.2.2 nsqd接收客户端消费请求部分"></a>2.2.2 nsqd接收客户端消费请求部分</h3><p>本节，简单介绍nsqd服务，接收到客户端SUB请求下，如何处理。在上面一节中，已经介绍了nsqd接收客户端字节流，然后解码的流程，下面主要分析SUB指令的处理流程：</p>
<p><img src="/images/2021/process_nsqd.png" alt="nsqd处理订阅流程"></p>
<h3 id="2-2-3-nsqd推送消息部分"><a href="#2-2-3-nsqd推送消息部分" class="headerlink" title="2.2.3 nsqd推送消息部分"></a>2.2.3 nsqd推送消息部分</h3><p>消费端发送订阅请求成功后，和nsqd服务保持一个连接conn，接下来，nsqd会将订阅的topic消息通过conn发送给消费端。</p>
<p>nsqd读取消息持久化存储数据，然后将消息数据最终写回订阅客户端的主要流程已经进行介绍，下面主要是介绍订阅到推送这部分流程：</p>
<p><img src="/images/2021/nsqd_push.png" alt="nsqd推送消息流程"></p>
<h1 id="三、nsq消费RDY管理"><a href="#三、nsq消费RDY管理" class="headerlink" title="三、nsq消费RDY管理"></a>三、nsq消费RDY管理</h1><p>首先，带上RDY指令，看看消费端和nsq服务端的交互流程：</p>
<p><img src="/images/2021/nsqd_rdy.png" alt="rdy交互流程"></p>
<p>因此，RDY管理，主要包括：客户端的RDY更新策略，以及 服务端更新处理流程。其中客户端的rdy更新策略，上节已经介绍，本节接下来，主要是nsqd服务端的rdy实现细节。</p>
<p>在nsqd服务端的rdy能力上，主要包括对每个consumer客户端的rdy维护，以及在push的时候，根据rdy控制push速率。</p>
<h2 id="3-1-nsqd-RDY-更新维护"><a href="#3-1-nsqd-RDY-更新维护" class="headerlink" title="3.1 nsqd RDY 更新维护"></a>3.1 nsqd RDY 更新维护</h2><p><img src="/images/2021/dry_update.png" alt="rdy更新流程"></p>
<p>nsqd接收客户端，然后更新对应rdy值逻辑很简单。本质上，就是对维护在client上的变量做原子更新，就ok了。</p>
<h2 id="3-2-nsqd-RDY控制速率"><a href="#3-2-nsqd-RDY控制速率" class="headerlink" title="3.2 nsqd RDY控制速率"></a>3.2 nsqd RDY控制速率</h2><p>根据客户端提供的rdy值，控制推送速率。一般而言，就是发送消息的时候，判断下当前的rdy是否大于在途消息数，如果是，继续发送，否则停止。</p>
<p>具体nsqd的处理流程，如下：</p>
<p><img src="/images/2021/rdy_rate.png" alt="rdy控制推送流程"></p>
<p>因此，当我们consumer客户端暂时无法处理更多消息的时候，我们可以通过RDY指令来限制nsqd服务端推送消息的速率，从而达到更友好的限制姿势。</p>
<h1 id="四、自定义nsq消费限流设计"><a href="#四、自定义nsq消费限流设计" class="headerlink" title="四、自定义nsq消费限流设计"></a>四、自定义nsq消费限流设计</h1><p>nsq组件在nsqd服务端，会有自己的限流策略，避免nsqd服务因为流量太大导致系统问题。但是，这里主要介绍的是nsq消费端的限流策略，其保护的是消费端的业务系统。</p>
<p>结合上面对nsq的分析，尤其是针对nsq rdy能力的分析，我们可以充分利用rdy的特性来完成限流。</p>
<p>其大概的设计流程如下：</p>
<p><img src="/images/2021/nsq_rate.png" alt="nsq消费限流流程"></p>
<p>以上整体逻辑和思想比较简单，具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.youzan.pay.risk.commons.impl.listener.telsa;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.Maps;  </span><br><span class="line"><span class="keyword">import</span> com.youzan.nsq.client.Consumer;  </span><br><span class="line"><span class="keyword">import</span> com.youzan.nsq.client.entity.NSQMessage;  </span><br><span class="line"><span class="keyword">import</span> com.youzan.nsq.client.exception.NSQException;  </span><br><span class="line"><span class="keyword">import</span> com.youzan.tesla.trafficlimit.portadapter.driving.manual.ProgrammingTrafficLimitAdapter;  </span><br><span class="line"><span class="keyword">import</span> com.youzan.tesla.trafficlimit.portadapter.driving.manual.TrafficLimitDecision;  </span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.util.Map;  </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;  </span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 基于xxx限流组件的nsq限流组件  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> tao.ke Date: 2021/10/11 Time: 10:40 上午  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@Slf4j</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NsqRateLimitComponent</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 最大避让时间为2s  </span></span><br><span class="line"><span class="comment"> */</span> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MAX_BACKOFF_PERIOD = <span class="number">2000L</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 避让时间因子  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> BACKOFF_MULTIPLIER = <span class="number">100L</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, AtomicInteger&gt; topic2BackoffCounter = Maps.newConcurrentMap();  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ProgrammingTrafficLimitAdapter programmingTrafficLimitAdapter;  </span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NsqRateLimitComponent</span><span class="params">(String appName)</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">  		<span class="comment">// 初始化限流组件对象</span></span><br><span class="line">        <span class="keyword">this</span>.programmingTrafficLimitAdapter = <span class="keyword">new</span> ProgrammingTrafficLimitAdapter(() -&gt; appName);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 处理限流判断和相关动作  </span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> nsqMessage nsq消息  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 是否触发限流操作  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">processLimit</span><span class="params">(NSQMessage nsqMessage, String channel, Consumer nsqConsumer)</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">        Map&lt;String, String&gt; features = Maps.newHashMap();  </span><br><span class="line">        String topic = nsqMessage.getTopicInfo().getTopicName();  </span><br><span class="line">        features.put(<span class="string">&quot;topic&quot;</span>, topic);  </span><br><span class="line">        features.put(<span class="string">&quot;channel&quot;</span>, channel);  </span><br><span class="line"></span><br><span class="line">        <span class="comment">// 限流组件决策是否超过设置的阈值</span></span><br><span class="line">        TrafficLimitDecision decision = <span class="keyword">this</span>.programmingTrafficLimitAdapter.apply(features);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 不限流，直接返回false  </span></span><br><span class="line"> 		<span class="keyword">if</span> (!decision.shouldLimit()) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        AtomicInteger backoffCounter = topic2BackoffCounter.computeIfAbsent(topic, t -&gt; <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>));  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//backoff and requeue  </span></span><br><span class="line"> 		<span class="keyword">long</span> backoffPeriod = calculateBackoff(backoffCounter.get() + <span class="number">1</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//max backoff delay  </span></span><br><span class="line"> 		<span class="keyword">if</span> (backoffPeriod &gt; <span class="number">0L</span>) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (backoffPeriod &gt; MAX_BACKOFF_PERIOD) &#123;  </span><br><span class="line">                backoffPeriod = MAX_BACKOFF_PERIOD;  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                backoffCounter.incrementAndGet();  </span><br><span class="line">            &#125;  </span><br><span class="line">            nsqMessage.disableAutoResponse();  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                <span class="comment">// 消息重新入队列，并且同时backoff  </span></span><br><span class="line"> nsqMessage.requeue((<span class="keyword">int</span>) TimeUnit.MILLISECONDS.toSeconds(backoffPeriod), <span class="keyword">true</span>, backoffPeriod);  </span><br><span class="line">                log.warn(<span class="string">&quot;[NSQ消费限流] &#123;&#125;:&#123;&#125; backoff in next &#123;&#125;ms&quot;</span>, topic, channel, backoffPeriod);  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (NSQException e) &#123;  </span><br><span class="line">                log.warn(<span class="string">&quot;[NSQ消费限流] fail to backoff &#123;&#125;:&#123;&#125; as connection may closed. Exception: &#123;&#125;&quot;</span>, topic, channel, e.getLocalizedMessage());  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 根据之前避让次数计算当前需要避让的时间  </span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> backoffCount 避让次数  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 避让时间  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">calculateBackoff</span><span class="params">(<span class="keyword">long</span> backoffCount)</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">long</span>) (BACKOFF_MULTIPLIER * Math.pow(<span class="number">2.0</span>, backoffCount));  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在<code>requeue()</code>发放中，对于<code>backoff</code>开关进行打开，内部会执行 <code>backoffTopicInMillSecond(Topic topic, long resumeDelayInMillSecond)</code></p>
<p>针对每一个topic+conn的连接，将rdy更新为0，同时，注册一个定时任务，在resumeDelayInMillSecond时间之后，执行rdy更新为1的操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ScheduledExecutorService resumeExec = Executors.newSingleThreadScheduledExecutor(<span class="keyword">new</span> NamedThreadFactory(<span class="string">&quot;resume-scheduler&quot;</span>, Thread.NORM_PRIORITY));</span><br><span class="line"></span><br><span class="line"><span class="comment">// resumeDelayRunnable 则是将rdy设置为1的操作</span></span><br><span class="line"><span class="comment">// 不管是设置为0，还是设置为1，都需要加lock，避免并发情况</span></span><br><span class="line">resumeExec.schedule(()-&gt; resumeDelayRunnable(topicName), resumeDelayInMillSecond, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h1><p>本文主要是针对nsq消费流程进行分析，同时，为了最终消费限流目标，本文重点分析了nsq内部限制推送速率的rdy机制。由于nsq客户端默认的rdy更新策略已经比较完善，并且调整起来，比较难达到所见即所得的限流效果。</p>
<p>因此，本文使用直接将rdy设置为0的策略，粗暴的暂停nsqd服务端消息推送，在一段时间之后，再设置为1，根据rdy的更新策略，逐步恢复rdy到设置的最大阈值。</p>
<h1 id="六、补充"><a href="#六、补充" class="headerlink" title="六、补充"></a>六、补充</h1><p>本文对于消息磁盘持久化的介绍和分析，只是简单提到。虽然有赞对文件持久化的内容和格式做了一些优化和调整，不过如果想了解细节，可以先从<a target="_blank" rel="noopener" href="https://www.cnblogs.com/li-peng/p/11868059.html">剖析nsq消息队列(三) 消息传输的可靠性和持久化[二]diskqueue</a> 入手，了解下原生nsq架构的持久化。</p>
<p>此外，有赞对nsq的改造，也可以从上面的 github doc 文档列表上，找到一些有用的资料。</p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>柯小小西
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://ketao1989.github.io/2021/10/23/2021-10-23-nsq-consume-code-analyse-and-rate-limit-componet-implement/" title="nsq消息消费原理分析&amp;消费限流实现">https://ketao1989.github.io/2021/10/23/2021-10-23-nsq-consume-code-analyse-and-rate-limit-componet-implement/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/09/10/2021-09-10-how-to-code-review-for-dev/" rel="prev" title="开发团队应该如何高效进行Code Review">
      <i class="fa fa-chevron-left"></i> 开发团队应该如何高效进行Code Review
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E8%83%8C%E6%99%AF"><span class="nav-number">1.</span> <span class="nav-text">一、背景</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81nsq%E6%B6%88%E8%B4%B9%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">二、nsq消费流程分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-nsq-consumer-client-%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 nsq consumer client 实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-1-%E6%9E%84%E9%80%A0consumer%E5%AF%B9%E8%B1%A1"><span class="nav-number">2.1.1.</span> <span class="nav-text">2.1.1 构造consumer对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-2-%E5%90%AF%E5%8A%A8consumer%EF%BC%8C%E8%AF%B7%E6%B1%82%E6%B6%88%E8%B4%B9%E6%B6%88%E6%81%AF"><span class="nav-number">2.1.2.</span> <span class="nav-text">2.1.2 启动consumer，请求消费消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-3-%E6%8E%A5%E6%94%B6-amp-%E5%A4%84%E7%90%86nsq%E6%B6%88%E6%81%AF"><span class="nav-number">2.1.3.</span> <span class="nav-text">2.1.3 接收&amp;处理nsq消息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-nsqd-%E8%AE%A2%E9%98%85%E9%80%BB%E8%BE%91%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 nsqd 订阅逻辑实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-nsqd%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E9%83%A8%E5%88%86"><span class="nav-number">2.2.1.</span> <span class="nav-text">2.2.1 nsqd服务启动部分</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-1-%E6%9E%84%E9%80%A0nsqd-server%E5%AE%9E%E4%BE%8B"><span class="nav-number">2.2.1.1.</span> <span class="nav-text">2.2.1.1  构造nsqd server实例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-2-%E5%85%83%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD"><span class="nav-number">2.2.1.2.</span> <span class="nav-text">2.2.1.2 元数据加载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-3-%E5%90%AF%E5%8A%A8nsqd-server-%E6%9C%8D%E5%8A%A1"><span class="nav-number">2.2.1.3.</span> <span class="nav-text">2.2.1.3 启动nsqd server 服务</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-nsqd%E6%8E%A5%E6%94%B6%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B6%88%E8%B4%B9%E8%AF%B7%E6%B1%82%E9%83%A8%E5%88%86"><span class="nav-number">2.2.2.</span> <span class="nav-text">2.2.2 nsqd接收客户端消费请求部分</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-3-nsqd%E6%8E%A8%E9%80%81%E6%B6%88%E6%81%AF%E9%83%A8%E5%88%86"><span class="nav-number">2.2.3.</span> <span class="nav-text">2.2.3 nsqd推送消息部分</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81nsq%E6%B6%88%E8%B4%B9RDY%E7%AE%A1%E7%90%86"><span class="nav-number">3.</span> <span class="nav-text">三、nsq消费RDY管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-nsqd-RDY-%E6%9B%B4%E6%96%B0%E7%BB%B4%E6%8A%A4"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 nsqd RDY 更新维护</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-nsqd-RDY%E6%8E%A7%E5%88%B6%E9%80%9F%E7%8E%87"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 nsqd RDY控制速率</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89nsq%E6%B6%88%E8%B4%B9%E9%99%90%E6%B5%81%E8%AE%BE%E8%AE%A1"><span class="nav-number">4.</span> <span class="nav-text">四、自定义nsq消费限流设计</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-number">5.</span> <span class="nav-text">五、总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E8%A1%A5%E5%85%85"><span class="nav-number">6.</span> <span class="nav-text">六、补充</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="柯小小西"
      src="/images/ava.gif">
  <p class="site-author-name" itemprop="name">柯小小西</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">53</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">54</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">柯小小西</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">506k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">7:40</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'JHHXvxc1poIUYczSRlzKC3hQ-MdYXbMMI',
      appKey     : 'yV8QHmFeQEBNceFuU9tKH3cl',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
